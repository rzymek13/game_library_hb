<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{header :: head}"></head>
<body>

<div th:replace="~{header :: navbar}"></div>

<div class="container" style="margin-top: 100px;">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <h2 class="page-title text-center w-100">Add Match Result</h2>

            <div class="card p-4">
                <form id="matchForm">

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="homeTeam" class="form-label text-muted text-uppercase fw-bold small">Home Team</label>
                            <select class="form-select form-select-lg bg-dark text-white border-secondary" id="homeTeam" required>
                                <option value="" disabled selected>Select Home Team</option>
                                <option th:each="team : ${teams}" th:value="${team.name}" th:data-id="${team.id}" th:text="${team.name}"></option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="awayTeam" class="form-label text-muted text-uppercase fw-bold small">Away Team</label>
                            <select class="form-select form-select-lg bg-dark text-white border-secondary" id="awayTeam" required>
                                <option value="" disabled selected>Select Away Team</option>
                                <option th:each="team : ${teams}" th:value="${team.name}" th:data-id="${team.id}" th:text="${team.name}"></option>
                            </select>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-6 col-md-3">
                            <label for="homeTeamGoals" class="form-label text-muted text-uppercase fw-bold small">Home Goals</label>
                            <input type="number" class="form-control form-control-lg bg-dark text-white border-secondary text-center" id="homeTeamGoals" min="0" required>
                        </div>
                        <div class="col-6 col-md-3">
                            <label for="awayTeamGoals" class="form-label text-muted text-uppercase fw-bold small">Away Goals</label>
                            <input type="number" class="form-control form-control-lg bg-dark text-white border-secondary text-center" id="awayTeamGoals" min="0" required>
                        </div>

                        <!-- Penalty Section (Initially Hidden) -->
                        <div class="col-12 col-md-6" id="penaltySection" style="display: none;">
                            <div class="row">
                                <div class="col-6">
                                    <label for="homeTeamPenaltyGoals" class="form-label text-muted text-uppercase fw-bold small text-warning">Home Pen.</label>
                                    <input type="number" class="form-control form-control-lg bg-dark text-warning border-warning text-center" id="homeTeamPenaltyGoals" min="0" value="0">
                                </div>
                                <div class="col-6">
                                    <label for="awayTeamPenaltyGoals" class="form-label text-muted text-uppercase fw-bold small text-warning">Away Pen.</label>
                                    <input type="number" class="form-control form-control-lg bg-dark text-warning border-warning text-center" id="awayTeamPenaltyGoals" min="0" value="0">
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr class="border-secondary my-4">

                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="text-white mb-3">Home Team Players</h5>
                            <div id="homePlayersList" class="vstack gap-2">
                                <p class="text-muted small">Select a team to load players.</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h5 class="text-white mb-3">Away Team Players</h5>
                            <div id="awayPlayersList" class="vstack gap-2">
                                <p class="text-muted small">Select a team to load players.</p>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 mt-5">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-check-circle-fill me-2"></i> Submit Result
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{header :: scripts}"></div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const homeTeamSelect = document.getElementById('homeTeam');
        const awayTeamSelect = document.getElementById('awayTeam');
        const homePlayersList = document.getElementById('homePlayersList');
        const awayPlayersList = document.getElementById('awayPlayersList');
        const homeTeamGoalsInput = document.getElementById('homeTeamGoals');
        const awayTeamGoalsInput = document.getElementById('awayTeamGoals');
        const penaltySection = document.getElementById('penaltySection');

        // Load players when team changes
        homeTeamSelect.addEventListener('change', () => loadPlayers(homeTeamSelect, homePlayersList));
        awayTeamSelect.addEventListener('change', () => loadPlayers(awayTeamSelect, awayPlayersList));

        // Show/Hide penalty section based on score
        function checkScore() {
            const home = parseInt(homeTeamGoalsInput.value) || 0;
            const away = parseInt(awayTeamGoalsInput.value) || 0;
            if (home === away && homeTeamGoalsInput.value !== '' && awayTeamGoalsInput.value !== '') {
                penaltySection.style.display = 'block';
            } else {
                penaltySection.style.display = 'none';
                document.getElementById('homeTeamPenaltyGoals').value = 0;
                document.getElementById('awayTeamPenaltyGoals').value = 0;
            }
        }
        homeTeamGoalsInput.addEventListener('input', checkScore);
        awayTeamGoalsInput.addEventListener('input', checkScore);

        function loadPlayers(selectElement, listContainer) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const teamId = selectedOption.getAttribute('data-id');
            const teamName = selectedOption.value;

            if (!teamId) return;

            listContainer.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';

            fetch(`/api/team/${teamId}/players`)
                .then(response => response.json())
                .then(players => {
                    listContainer.innerHTML = '';
                    if (players.length === 0) {
                        listContainer.innerHTML = '<p class="text-muted small">No players found.</p>';
                        return;
                    }
                    players.forEach(player => {
                        const div = document.createElement('div');
                        div.className = 'input-group input-group-sm';
                        div.innerHTML = `
                            <span class="input-group-text bg-dark text-white border-secondary w-50">${player.name}</span>
                            <input type="number" class="form-control bg-dark text-white border-secondary player-goals"
                                   data-player-name="${player.name}" data-team-name="${teamName}" placeholder="Goals" min="0">
                        `;
                        listContainer.appendChild(div);
                    });
                })
                .catch(error => {
                    console.error('Error loading players:', error);
                    listContainer.innerHTML = '<p class="text-danger small">Error loading players.</p>';
                });
        }

        document.getElementById('matchForm').addEventListener('submit', function(e) {
            e.preventDefault();

            // --- Client-side validation ---
            const homeGoals = parseInt(homeTeamGoalsInput.value);
            const awayGoals = parseInt(awayTeamGoalsInput.value);

            let homePlayerGoalsSum = 0;
            document.querySelectorAll('#homePlayersList .player-goals').forEach(input => {
                homePlayerGoalsSum += parseInt(input.value) || 0;
            });

            if (homePlayerGoalsSum !== homeGoals) {
                alert(`Validation Error: Home team total goals (${homeGoals}) do not match sum of player goals (${homePlayerGoalsSum}).`);
                return;
            }

            let awayPlayerGoalsSum = 0;
            document.querySelectorAll('#awayPlayersList .player-goals').forEach(input => {
                awayPlayerGoalsSum += parseInt(input.value) || 0;
            });

            if (awayPlayerGoalsSum !== awayGoals) {
                alert(`Validation Error: Away team total goals (${awayGoals}) do not match sum of player goals (${awayPlayerGoalsSum}).`);
                return;
            }
            // --- End of validation ---

            const homeTeamName = homeTeamSelect.value;
            const awayTeamName = awayTeamSelect.value;
            const homePen = parseInt(document.getElementById('homeTeamPenaltyGoals').value) || 0;
            const awayPen = parseInt(document.getElementById('awayTeamPenaltyGoals').value) || 0;

            // Calculate result
            let result = 0;
            if (homeGoals > awayGoals) result = 1;
            else if (awayGoals > homeGoals) result = 2;
            else {
                if (homePen > awayPen) result = 3;
                else if (awayPen > homePen) result = 4;
                else {
                    alert("Draw in penalties is not allowed!");
                    return;
                }
            }

            // Collect player goals
            const matchPlayers = [];
            document.querySelectorAll('.player-goals').forEach(input => {
                const goals = parseInt(input.value);
                if (goals > 0) {
                    matchPlayers.push({
                        playerName: input.getAttribute('data-player-name'),
                        goals: goals,
                        team: input.getAttribute('data-team-name')
                    });
                }
            });

            const matchData = {
                homeTeam: { name: homeTeamName },
                awayTeam: { name: awayTeamName },
                homeTeamGoals: homeGoals,
                awayTeamGoals: awayGoals,
                result: result,
                homeTeamPenaltyGoals: homePen,
                awayTeamPenaltyGoals: awayPen,
                matchPlayers: matchPlayers
            };

            fetch('/handball/matches', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(matchData)
            })
            .then(response => {
                if (response.ok) {
                    alert('Match added successfully!');
                    window.location.href = '/standings';
                } else {
                    response.text().then(text => alert('Error adding match: ' + text));
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });
</script>

</body>
</html>
